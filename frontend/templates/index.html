<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TETRIS</title>
    <link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">

</head>
<body>
    
    <h1 class="logo rainbow-text">P O R T S C A N N E R</h1>

    <!-- 스캐너 -->
    <div class="button-container">
        <label class="menu-button">
            <input type="radio" name="scanner" value="s1" checked>
            <span class="checkmark"></span>
            포트 확인
        </label>
        <label class="menu-button">
            <input type="radio" name="scanner" value="s2">
            <span class="checkmark"></span>
            포트+서비스 확인
        </label>
    </div>

    <!-- 검색창 -->
    <div class="search-container">
        <input type="text" id="ip" class="search-input" name="ip" title="검색" value="" placeholder = "127.0.0.1"aria-label="검색" autofocus>
    
        <input class="search-input port" type="number" min="0" max="65535" placeholder="Port         0">
        <input class="search-input port port2" type="number" min="1" max="65535" placeholder="~ 65535">
     
        <button id="scanButton" type="submit" class="search-button" onclick="startPortScan()">검색</button>
    
    </div>


    <!-- 인덱스 -->
    <div id ="scanResult" class="index">
        <h2>검색결과</h2>
    </div>

    <!-- JavaScript를 통해 이미지를 동적으로 생성 -->
    
    <script>
        var blockImages = [];

        for (var i = 1; i <= 7; i++) {
            var blockImg = new Image();
            blockImg.src = "../static/img/" + i + ".png";
            blockImages.push(blockImg);
        }
        function createFallingBlock() {
            const block = document.createElement('div');
            block.className = 'tetris-block';
            const randomLeft = Math.random() * 100 + '%';
            block.style.left = randomLeft;
            const randomImage = Math.floor(Math.random() * 7); 
            const blockImg = blockImages[randomImage].cloneNode(true);
            
            const randomRotate = Math.floor(Math.random() * 4); 
            blockImg.style.transform = 'rotate('+randomRotate*90+'deg)';

            block.appendChild(blockImg);
            document.body.appendChild(block);

            setTimeout(function () {
                block.remove();
            }, 5000);
        }setInterval(function() {      createFallingBlock();    }, 1000);


        function startPortScan() {
            let ipAddress = document.querySelector('#ip').value;
            let minPort = document.querySelector('.search-input.port').value;
            let maxPort = document.querySelector('.search-input.port2').value;
            let Stype = 's1';
            document.getElementsByName('scanner').forEach((node) => {
                if(node.checked)  {  Stype = node.value;  }
            }) 

            if(!ipAddress){
                alert('IP주소를 입력해주세요.');
                return;
            }

            var ips = ipAddress.split('.');
            if(ips.length!=4){
                alert('IP주소를 제대로 입력해주세요.');
                return;
            }
            
            if(!minPort) {document.querySelector('.search-input.port').value = 1; minPort=1;}
            if(!maxPort) {document.querySelector('.search-input.port2').value = 65535; maxPort=65535;}
            if(minPort>maxPort){
                alert('최소 포트가 더 크게 입력되었습니다.');
                return;
            }

            const scanButton = document.getElementById('scanButton');
            const scanResult = document.getElementById('scanResult');
            scanButton.disabled = true;
            scanResult.innerHTML = '<h2>IP '+ipAddress+' 검색중..</h2>'

            fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ip: ipAddress,minPort:minPort,maxPort:maxPort,Stype:Stype }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json(); 
            })
            .then(data => {
                scanButton.disabled = false;
                if(data.error){
                    alert('에러발생: '+data.error);
                    document.getElementById("scanResult").innerHTML = "오류 발생: " + data.error;
                    return;
                }
                const resultDiv = document.getElementById('scanResult');
                if (Object.keys(data).length>0) {
                    resultDiv.innerHTML = '<h2>['+ipAddress+']<h2>';

                    for (const port in data) {
                        if (data.hasOwnProperty(port)) {
                            const status = data[port];
                            const div = document.createElement('div');

                            const heading = document.createElement('h3');
                            heading.textContent = `포트: ${port}`;

                            const details = document.createElement('details');
                            const summary = document.createElement('summary');
                            summary.textContent = status[0];
                            const detailsContent = document.createElement('div');
                            detailsContent.style.padding = '30px';
                            detailsContent.textContent = status[1];
                            

                            details.appendChild(summary);
                            details.appendChild(detailsContent);

                            div.appendChild(heading);
                            div.appendChild(details);

                            resultDiv.appendChild(div);

                            summary.id='summary'
                            div.addEventListener("mousedown", (e) => {
                                if(e.target.id!='summary')   details.open = !details.open;
                            });
                        }
                    }
                } else {
                    resultDiv.innerHTML = '결과없음';
                }
            })
            .catch(error => {
                scanButton.disabled = false;
                document.getElementById("scanResult").innerHTML = "오류 발생: " + error;
            });
        }
    </script>
</body>
<style> 
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
    }
    body {
        font-family: Arial, sans-serif;
        background-color: #131313;
        overflow: hidden;
    }

    .logo {
        text-align: center;
        font-size: 48px;
        font-family: 'Press Start 2P', cursive;
        z-index: 1;
        margin:0;
        padding-top:6%;
    }

    .rainbow-text {
        background-image: linear-gradient(200deg, 
            #FF0000, #FF3300, #FF6600, #FF9900, #FFCC00, #00FFFF, #33CCFF, #6699FF, 
            #9966FF, #CC33FF, #FF00FF, #FF00CC, #FF0099, #FF0066, #FF0033, #FF0000
        );
        -webkit-background-clip: text;
        -moz-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .search-container {
        text-align: center;
        margin-bottom: 40px;
        z-index: 1;
    }

    .search-input {
        padding: 10px;
        width: 500px;
        border: 3px solid #69fffc;
        border-radius: 24px;
        outline: none;
        font-size: 18px;
    }
    .port{
        width: 100px;
        border-radius: 24px 0 0 24px;
        margin-right:0px;
    }
    .port2{
        border-radius: 0 24px 24px 0;
    }
    .search-button {
        padding: 10px 20px;
        background-color: #b3efdd;
        color: #000000;
        border: none;
        border-radius: 24px;
        cursor: pointer;
        font-size: 18px;
        margin-left: 10px;
    }

    /* 버튼 스타일 */  
    .button-group {
        display: flex;
        justify-content: center;
    }
    
    .button-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        margin-top: 40px;
    }

    .menu-button {
        display: flex;
        align-items: center;
        margin: 15px;
        cursor: pointer;
        font-size: 13px;
        color: #69fffc
    }

    .menu-button input[type="radio"] {
        position: absolute;
        opacity: 0;
    }

    .checkmark {
        position: relative;
        display: inline-block;
        width: 18px;
        height: 18px;
        background-color: #69fffc;
        border-radius: 50%;
        margin-right: 8px;
        transition: background-color 0.3s;
    }

    .menu-button input[type="radio"]:checked + .checkmark {
        background-color: #fbff00;
    }

    .menu-button input[type="radio"]:checked + .checkmark::before {
        content:'💢';
    }

    /* 인덱스 스타일 */
    .index {
        text-align: center;
        margin-top: 50px;
        padding: 20px;
        border: 4px solid #69fffc;
        border-radius: 10px;
        background-color: white;
        height: 50%;
        width: 70%;
        margin: 0 auto;
        font-size: 17px;
        z-index: 1;
        overflow-y: scroll;
    }

    .tetris-block {
        position: absolute;
        animation: fall 5s linear infinite;
        z-index: -1;
        top: 0;
    }

    .tetris-block img {
        width: 100%;
        height: 100%;
    }
    #scanResult div {
        border: 3px solid #b693ff;
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
        background: #ffffff20;
        cursor: pointer;
    }
    #scanResult h3 {
        margin: 0;
    }
    details {
        margin-top: 10px;
    }
    summary {
        list-style: none;
    }
    summary::before {
        content: '▶'; 
        display: inline-block;
        width: 1em;
        text-align: center;
        margin-right: 0.5em;
    }
    details[open] summary::before {
        content: '▼'; /* 열린 요약 상자에는 열린 모양으로 변경 */
    }
    details > div {
        margin-top: 5px;
        background: #ffffff40;
    }
    

    @keyframes fall {
        0% {
            top: -30%;
        }
        100% {
            top: 120%;
        }
    }
</style>
</html>
